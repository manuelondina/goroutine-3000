name: Sync Main to Develop

on:
  push:
    branches:
      - main

jobs:
  sync-branches:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure develop branch exists locally
        run: |
          if git ls-remote --exit-code origin develop &> /dev/null; then
            git fetch origin develop:develop
          else
            echo "‚ö†Ô∏è Develop branch does not exist. Please create it first."
            exit 0
          fi

      - name: Create or Update Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          EXISTING_PR=$(gh pr list --base develop --head main --state open --json number --jq '.[0].number')

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --base develop \
              --head main \
              --title "üîÑ Auto-sync: Merge main into develop" \
              --body "$(cat <<EOF
This is an automated pull request to sync changes from \`main\` into \`develop\`.

### Changes included:
- Latest updates from main branch
- Keeps develop branch aligned with production

**Note:** This PR was automatically created by the sync workflow when changes were pushed to main.
EOF
)"
              --label autosync

            echo "‚úÖ Created new PR"
          else
            echo "‚ÑπÔ∏è PR #$EXISTING_PR already exists; it will update automatically when main changes"
          fi
